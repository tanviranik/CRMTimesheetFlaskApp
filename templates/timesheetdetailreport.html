{% extends 'base.html' %}

{% block content %}
<div class="row border-bottom">
    <nav class="navbar navbar-fixed-top custom-nav-pad" role="navigation" style="margin-bottom: 0;">
        <div class="navbar-header flex flex-start">
            <!-- <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a> -->
            <div class="m-auto page-title"> {{the_title}} </div>
        </div>
        <ul class="nav navbar-top-links navbar-right">
            <li>
                <a href="login.html">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </li>            
        </ul>
    </nav>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div id="report-page">
        <div class="report-control flex flex-start">
            <button :class="['btn','btn-default']" onclick="ExporttoExcel('timesheetdetails',this)"><i class="far fa-file-excel"></i></button>
            <button :class="['btn','btn-default']" @click="printReport"><i class="fas fa-print"></i></button>
            <button :class="['btn','btn-default',(isFilter===true ? 'btn-default-active' : '')]" @click="toggleFilter"><i class="fas fa-filter"></i></button>
            <button :class="['btn','btn-default']" onclick="zoomIn()"><i class="fas fa-search-plus"></i></button>
            <button :class="['btn','btn-default']" onclick="zoomOut()"><i class="fas fa-search-minus"></i></button>
        </div>
        <div id="report-body" class="flex">
            <div id="report-viewer" :class="[(isFilter===true ? 'col-md-9' : 'col-md-12')]">
                <div id="print-area">
                    <div class="report-header mb-1">
                        <div class="report-title"> Timesheet Details for [[employee_name]]</div>
                        <div class="flex align-between col-md-3">
                            <p> Week Start Date :</p>
                            <p> [[filterby.startdate]]</p>
                        </div>
                        <div class="flex align-between col-md-3">
                            <p> Week End Date :</p>
                            <p> [[filterby.enddate]]</p>
                        </div>
                    </div>
                    <div class="report-content">
                        <table class="table table-responsive table-bordered table-report">
                            <thead>
                                <tr>
                                    <th v-for="(head, index) in reportdataheader" class="text-center">[[ head ]]</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(dt, index) in reportdata">
                                    <td>[[dt.entry_date]]</td>
                                    <td>[[dt.project_name]]</td>
                                    <td>[[dt.task_name]]</td>
                                    <td>[[dt.start_time]]</td>
                                    <td>[[dt.end_time]]</td>
                                    <td class="text-right">[[dt.total_hours]]</td>
                                </tr>
                                <tr>
                                    <td colspan="5"class="text-right"><b>Total Working Hours</b></td>
                                    <td class="text-right">[[grandhours]]</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>                                    
            </div>
            <template v-if="isFilter">
                <div class="filter-group col-md-3 animated fadeInRight">
                    <div class="form-group">
                        <label>Date Range</label>
                        <select name="date_range" id="weekrange" class="form-control" v-model="filterby.date_range" @change="setDateRange">
                            <option value="1">This Week</option>
                            <!-- <option value="2">This Month</option>
                            <option value="3">Last Week</option>
                            <option value="4">Last Month</option>
                            <option value="5">Last 30 Days</option>
                            <option value="6">Last 60 Days</option>
                            <option value="7">Last 90 Days</option> -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input id="startdate" type="text" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input id="enddate"  type="text" class="form-control" />
                    </div>
                    <!-- <div class="form-group">
                        <label>Primary Grouping</label>
                        <select name="primary_grouping" class="form-control">
                            <option value="0">Select</option>
                            <option value="1">Project</option>
                            <option value="2">Task</option>
                            <option value="3">Date</option>
                            <option value="4">Customer</option>
                            <option value="5">Status</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Secondary Grouping</label>
                        <select name="secondary_grouping" class="form-control">
                            <option value="0">Select</option>
                            <option value="1">Project</option>
                            <option value="2">Task</option>
                            <option value="3">Date</option>
                            <option value="4">Customer</option>
                            <option value="5">Status</option>
                        </select>
                    </div> -->
                    <div class="form-group">
                        <label>Project</label>
                        <select name="filterby.project_id" id="project_id" class="form-control search-select">
                            <option value="0">Select</option>
                            <option v-for="proj in projectlist" :value="proj.project_id">[[proj.project_name]]</option>                            
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Task</label>
                        <select name="filterby.task_id" id="task_id" class="form-control search-select">
                            <option value="0">Select</option>
                            <option v-for="task in tasklist" :value="task.task_id">[[task.task_name]]</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select name="filterby.category_id" id="category_id" class="form-control search-select">
                            <option value="0">Select</option>
                            <option v-for="category in categorylist" :value="category.category_id">[[category.category_name]]</option>
                        </select>
                    </div>
                    <!-- <div class="form-group">
                        <label>Status</label>
                        <select name="status" class="form-control">
                            <option value="0">Select</option>
                            <option value="1">Pending</option>
                            <option value="2">Approved</option>
                            <option value="3">Automatically Approved</option>
                            <option value="4">Rejected</option>
                            <option value="5">Invoiced</option>
                        </select>
                    </div> -->
                    <div class="form-group">                                            
                        <button class="btn btn-success" @click="LoadReport">Preview</button>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>


<script>
    const reportcsslink = "{{ url_for('static', filename='css/print.css') }}";
    const reportapp = {
        data() {
            return {
                pagetitle: 'Report - Time Sheet Detail',
                isFilter: true,
                reportdataheader: ['Date', 'Project Name', 'Task Name','Start Time', 'End Time', 'Duration'],
                employee_name: '',
                reportdata: [],
                selectedDay: new Date(),
                selectedDayStr: '',
                selectedDayArr:[],
                stubstartdateStr: '',
                stubenddateStr: '',
                grandhours: '0:00',
                filterby:{
                    date_range: '1',
                    startdate: '',
                    enddate: '',
                    primary_grouping: '',
                    secondary_grouping: '',
                    project_id: '0',
                    task_id:'0',
                    category_id:'0',
                    status: '',
                    emp_id: 1
                },
                weeklist: [],
                selectedweek: {},
                tasklist: [],
                projectlist: [],
                categorylist: [],
                reportUrl: 'gettimesheetdetail',
                weekUrl: 'GetPayStubWeek',
                supportingUrl: 'get_supporting_data',
            }
        },
        delimiters: ['[[',']]'],
        mounted: function () {
            let self = this;
            self.loadDefault();
            $('.search-select').select2();
            $('select#task_id').on('change', function() {
                console.log('task onchange fired');
                self.filterby.task_id = parseInt($("select#task_id option").filter(":selected").val());
            });
            $('select#category_id').on('change', function() {
                console.log('category onchange fired');
                self.filterby.category_id = parseInt($("select#category_id option").filter(":selected").val());
            });
            $('select#project_id').on('change', function() {
                console.log('project_id onchange fired');
                self.filterby.project_id = parseInt($("select#project_id option").filter(":selected").val());
            });
            $( "#startdate").datepicker({
                showAnim: 'slideDown',
                dateFormat: 'yy-mm-dd',
                firstDay: 1,
                onSelect: function (dateText, inst) {
                    // assign selected date
                    self.filterby.startdate = dateText;
                }
            });
            $( "#enddate").datepicker({
                showAnim: 'slideDown',
                dateFormat: 'yy-mm-dd',
                firstDay: 1,
                onSelect: function (dateText, inst) {
                    // assign selected date
                    self.filterby.enddate = dateText;
                }
            });
        },
        methods: {
            loadDefault() {
                let self = this;
                showloading();
                self.pagetitle = 'Timesheet Detail Report';
                self.selectedDayStr = getcalenderformat(self.selectedDay);
                helper.get(self.supportingUrl, {}, function (response) {
                    self.categorylist = response.data.categorylist;
                    self.tasklist = response.data.tasklist;
                    self.projectlist = response.data.projectlist;
                }, true);
                self.selectedDayArr = self.selectedDay.toString('en-us').split(' ');
                self.stubstartdateStr = '';
                self.stubenddateStr = '';
                self.getWeekList();
            },
            getWeekList(){
                let self = this;
                helper.get(self.weekUrl, {}, function (response) {
                    self.weeklist = response.data;
                    self.selectedweek = self.weeklist.filter(function (element) {
                        return element.startdate <= self.selectedDayStr && element.enddate >= self.selectedDayStr;
                    });
                    console.log(self.selectedweek[0]);
                    self.SetupWeekCalendar();
                }, true);
            },
            LoadReport(){
                let self = this;
                showloading();
                data = JSON.stringify(self.filterby);
                helper.get(self.reportUrl, {filterby: data}, function (response) {
                    self.reportdata = response.data;
                    self.grandhours = '0:00';
                    if(self.reportdata.length > 0){
                        self.employee_name = self.reportdata[0].employee_name;
                        self.reportdata.forEach(element => {
                            self.grandhours = calculatingTotalHours(self.grandhours, element.total_hours);
                        });
                    }
                    stoploading();
                }, true);
            },
            SetupWeekCalendar(){
                let self = this;
                self.stubstartdateStr = self.selectedweek[0].startdate;
                self.stubenddateStr = self.selectedweek[0].enddate;
                self.filterby.startdate = self.selectedweek[0].startdate;
                self.filterby.enddate = self.selectedweek[0].enddate;
                $( "#startdate").datepicker({
                    showAnim: 'slideDown',
                    dateFormat: 'yy-mm-dd',
                    firstDay: 1,
                }).datepicker("setDate", new Date(self.stubstartdateStr));
                $( "#enddate").datepicker({
                    showAnim: 'slideDown',
                    dateFormat: 'yy-mm-dd',
                    firstDay: 1
                }).datepicker("setDate", new Date(self.stubenddateStr));
                self.LoadReport();
            },
            RefreshReport(){
                console.log(this.filterby);
            },
            setDateRange(){
                console.log(this.filterby.date_range);
                self.filterby.startdate = $("#StartDate").val();
                self.filterby.enddate = $("#enddate").val();
            },
            toggleFilter(){
                this.isFilter = (this.isFilter) ? false : true;
            },
            printReport(){
                printDivPortrait('print-area', reportcsslink);
            }            
        }
    }
    Vue.createApp(reportapp).mount('#report-page')
</script>
{% endblock %}